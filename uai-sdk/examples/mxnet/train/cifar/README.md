# CIFAR-10 Example

CIFAR-10 is a common benchmark in machine learning for image recognition.                                                                                      
                                                                                                                                                               
http://www.cs.toronto.edu/~kriz/cifar.html                                                                                                    

## Setup
下载train和val数据

	wget http://data.mxnet.io/data/cifar10/cifar10_val.rec
	wget http://data.mxnet.io/data/cifar10/cifar10_train.rec

## Intro

The main body of the resnet code is following the https://github.com/apache/incubator-mxnet/blob/master/example/image-classification/train\_cifar10.py

But we made appropriate modifications to run it on UAI platform.

## UAI Example  
                                                                                                                                               
We do following modifications to following files: train\_imagenet.py, common/fit.py
                                                                                                        
1. Add UAI SDK related arguments: --data\_dir, --output\_dir, --work\_dir, --log\_dir, --num\_gpus by adding following codes:

	```python
		from uaitrain.arch.mxnet import uargs
		
		if __name__ == '__main__':
		    ...
		    uargs.add_uai_args(parser)
		    ...
	```
these arguments are auto generated by UAI Train Platform, see: https://github.com/ucloud/uai-sdk/blob/master/uaitrain/arch/mxnet/uargs.py for more details 
                                                             
2. Modify code to use UAI arguments: 
  
  - Add UAI output_dir path
	
	```python
	   fit.py L46:
	   def _load_model(args, rank=0):
	     ...
		  model_prefix = os.path.join(args.output_dir, args.model_prefix)
		  
		fit.py L60:
		def _save_model(args, rank=0):
		  ...
		  model_prefix = os.path.join(args.output_dir, args.model_prefix)
	``` 

  - Use args.num_gpus for gpu cnts
 
 ```python
   fit.py L165:
   def fit(args, network, data_loader, **kwargs):
     # devices for training
     # Add UAI multi-gpu dev support
     devs = mx.cpu() if args.num_gpus is None or args.num_gpus is 0 else [
        mx.gpu(i) for i in range(args.num_gpus)]
  ``` 

3. Use /data/data/ for data input inside the UAI MXNet Docker
4. We download the data using wget, we do not need to download data in the code

## How to run
We assume you fully understand how UAI Train docker image works and has already reads the DOCS here: https://docs.ucloud.cn/ai/uai-train/guide/tensorflow

1. Pack the imagenet example code into docker using mxtne\_tools.py provided in https://github.com/ucloud/uai-sdk/blob/master/uaitrain\_tool/mxnet/
2. Run the docker locally or push it into UAI Train platform to run.
   
#### The simplest CMD applied to run is 

     /usr/bin/python /data/train_cifar10.py
     
#### An pack cmd example is:

    sudo python mxnet_tool.py pack --public_key=<UCLOUD_PUB_KEY> \ 
    --private_key=<UCLOUD_PRIV_KEY> \
    --code_path=code/ \
    --mainfile_path=train_cifar10.py \
    --uhub_username=<UCLOUD_ACCOUNT> \
    --uhub_password=<UCLOUD_ACCOUNT_PASSWD> \
    --uhub_registry=<UHUB_DOCKER_REGISTRY> \
    --uhub_imagename=cifar10-mxnet \
    --ai_arch_v=mxnet-1.0.0 \
    --test_data_path=<LOCAL_PATH_TO_CIFAR_DATA_FOR_TEST> \
    --test_output_path=<LOCAL_PATH_TO_OUTOUT_FOR_TEST> \
    --train_params=""
   
Note: 
The tfrecords should stored in LOCAL\_PATH\_TO\_CIFAR\_DATA\_FOR\_TEST in this example for loacal test

e.g., We can put data into /mnt/cifar10/mxnet/

	$ ls /mnt/cifar10/mxnet/
	cifar10_val.rec :cifar10_train.rec
Then we can set --test_data_path=/mnt/cifar10/mxnet/
