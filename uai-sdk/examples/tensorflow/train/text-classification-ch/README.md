# Text Classification with CNN and RNN (Chinese)
This example shows how to use CNN/RNN to do text classification (Chinese). Here we shows how to run Text Classification example code on UAI Platform. This example is based on https://github.com/gaussic/text-classification-cnn-rnn.

## Setup
You should follow the "Dataset" of https://github.com/gaussic/text-classification-cnn-rnn to download the data. 
After download the dataset, it will looks like:

	/data/txt/
    |_ cnews
    |  |_ cnews.test.txt      
    |  |_ cnews.train.txt
    |  |_ cnews.val.txt
    |  |_ cnews.vocab.txt
 
## Intro
We make some modification to the original code to run it on UAI platform. We have provided the modified code for you. You can find it under examples/tensorflow/train/text-classification-ch/

## UAI Example
We do following modifications to the run\_cnn.py and run\_rnn.py:

Add UAI SDK related arguments parser: : --data\_dir, --output\_dir, --work\_dir, --log\_dir, --num\_gpus, these arguments are auto generated by UAI Train Platform and are defined in https://github.com/ucloud/uai-sdk/blob/master/uaitrain/arch/tensorflow/uflag.py.

We do the modifications to code/run\_cnn.py

	# L16 in code/run_cnn.py
	# change cnews_loader from data/cnews_loader to cnews_loader
	from cnews_loader import read_vocab, read_category, batch_iter, process_file, build_vocab

    # L18 in code/run_cnn.py
    # Add --train flags
    # import uflag from UAI-SDK, and let all xxx_dir point to related path
    tf.app.flags.DEFINE_string('train',  'train', 'train/test')

	FLAGS = tf.app.flags.FLAGS

	base_dir = 'cnews'
	train_dir = os.path.join(base_dir, 'cnews.train.txt')
	test_dir = os.path.join(base_dir, 'cnews.test.txt')
	val_dir = os.path.join(base_dir, 'cnews.val.txt')
	vocab_dir = os.path.join(base_dir, 'cnews.vocab.txt')

	save_dir = 'textcnn'
	save_path = ''

    # L68 in code/run_cnn.py
    # Let tensorboard located into /data/output/tensorboard/textcnn/. (FLAGS.log_dir is /data/output/)
    tensorboard_dir = 'tensorboard/textcnn'
    tensorboard_dir = os.path.join(FLAGS.log_dir, tensorboard_dir)

    # L194 use UAI dir for data input and output
    #      FLAGS.data_dir for data input path
    #      FLAGS.output_dir for checkpoints and event logs
    #      FLAGS.num_gpus for num of gpus
    if __name__ == '__main__':
   		print('Configuring CNN model...')
    	config = TCNNConfig()
 
    	data_dir = FLAGS.data_dir
    	train_dir = os.path.join(data_dir, train_dir)
    	test_dir = os.path.join(data_dir, test_dir)
    	val_dir = os.path.join(data_dir, val_dir)
    	vocab_dir = os.path.join(data_dir, vocab_dir)

    	save_path = os.path.join(FLAGS.output_dir, save_path)

    # L209 use FLAGS.train
    if FLAGS.train == 'train':
        train()
    else:
        test()

We do the same modifications to code/run\_rnn.py.

### Packing CNN/RNN training code
After Preparing the code (by modifying run\_cnn.py, run\_rnn.py and cnews\_loader.py), you can pack the txt-class docker. We provide the text-cnn-rnn.Dockerfile:

    FROM uhub.service.ucloud.cn/uaishare/gpu_uaitrain_ubuntu-16.04_python-2.7_tensorflow-1.7.0:v1.0

	COPY code/ /data/

It use the base image provided by UAI (tensorflow 1.7) and copy the code into /data/.

Suppose you get the text-cnn-rnn code, you can do the following steps to build your own UAI txt-class image:

    $ cd ${TEXT-CNN-RNN}
    $ ls code/
    cnews_loader.py  cnn_model.py ... run_rnn.py
    $ sudo docker build -t txt-class:test -f text-cnn-rnn.Dockerfile .

### Run CNN training
You can use the docker image txt-class:test to run text classification training locally with following cmd:

    $ sudo nvidia-docker run -v /data/txt/:/data/data/ -v /data/output/txt/:/data/output -it txt-class:test /bin/bash -c "python /data/run_cnn.py --train=train --data_dir=/data/data/ --output_dir=/data/output/ --log_dir=/data/output/ --num_gpus=1"

You can also run this docker image on UAI Train Platform. For more details please see https://docs.ucloud.cn/ai/uai-train.

### Run RNN training
You can use the docker image txt-class:test to run text classification training locally with following cmd:

    $ sudo nvidia-docker run -v /data/txt/:/data/data/ -v /data/output/txt/:/data/output -it txt-class:test /bin/bash -c "python /data/run_rnn.py --train=train --data_dir=/data/data/ --output_dir=/data/output/ --log_dir=/data/output/ --num_gpus=1"

You can also run this docker image on UAI Train Platform. For more details please see https://docs.ucloud.cn/ai/uai-train.