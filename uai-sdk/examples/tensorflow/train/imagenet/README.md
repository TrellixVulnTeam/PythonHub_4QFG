# Imagenet Example
Imagenet example includes image classification code for training on imagenet dataset.                                                                                                      
## Setup
You should follow https://github.com/tensorflow/models/tree/master/official/resnet/README.md to download and generate tfrecords of imagenet dataset

## Intro
The main body of the resnet code is following the https://github.com/tensorflow/models/tree/master/official/resnet/imagenet\_main.py. 

But we made appropriate modifications that it can run with single-GPU and multi-GPU. (multi-GPU implementation is similar to the cifar10 example) It use the high level tf.estimator.Estimator interface to run the training and use a device_setter to automatically assigned ops to CPU/GPU.

## UAI Example
We do following modifications to the imagenet\_main.py:  
                                                                                                        
1. Add UAI SDK related arguments: --data\_dir, --output\_dir, --work\_dir, --log\_dir, --num\_gpus, these arguments are auto generated by UAI Train Platform, see: https://github.com/ucloud/uai-sdk/blob/master/uaitrain/arch/tensorflow/uflag.py for more details                                                                
2. Modify code to use UAI arguments: use data_dir as input dir and use output\_dir as model output dir  
3. We add a ImagenetDataSet to prefetch data, in the make\_batch() func we generate the batch\_size for each gpu shard as shards\_batch\_size = int(batch\_size / num\_shards) and use a for loop to generate feature\_shards and label\_shards for each GPU one by one through iterator.get\_next(). 

## How to run
We assume you fully understand how UAI Train docker image works and has already reads the DOCS here: https://docs.ucloud.cn/ai/uai-train/guide/tensorflow

2. Pack the imagenet example code into docker using tf\_tools.py provided in https://github.com/ucloud/uai-sdk/blob/master/uaitrain\_tool/tf/
3. Run the docker locally or push it into UAI Train platform to run.
   
#### The simplest CMD applied to run is 
    /data/imagenet_main.py --train-batch-size=32 --resnet_size=101

#### An pack cmd example is
    sudo python tf_tool.py pack --public_key=<UCLOUD_PUB_KEY> \ 
    --private_key=<UCLOUD_PRIV_KEY> \
    --code_path=code/ \
    --mainfile_path=imagenet_main.py \
    --uhub_username=<UCLOUD_ACCOUNT> \
    --uhub_password=<UCLOUD_ACCOUNT_PASSWD> \
    --uhub_registry=<UHUB_DOCKER_REGISTRY> \
    --uhub_imagename=resnet-imagenet-tf \
    --ai_arch_v=tensorflow-1.4.0 \
    --test_data_path=<LOCAL_PATH_TO_IMAGENET_DATA_FOR_TEST> \
    --test_output_path=<LOCAL_PATH_TO_OUTOUT_FOR_TEST> \
    --train_params="--train-batch-size=32 --resnet_size=101"
   
Note: 
The tfrecords should stored in LOCAL\_PATH\_TO\_IMAGENET\_DATA\_FOR\_TEST in this example for loacal test


### Performance
System configuration

| Config      |      Value                                |
| ----------- | ----------------------------------------- |
| Tensorflow  | tensorflow-1.4.0-cp27-none-linux\_x86\_64 |
| batch\_size | 32 for each GPU                           |
| Optimizer   | MomentumOptimizer                         |
| ps_device   | CPU                                       | 


Performance Result

| Model                   | Node Type   | images/sec |
| ------------------------| ----------- | ---------- |
| `imagenet-resnet-101`   | 1 * P40     | 78         |
| `imagenet-resnet-101`   | 4 * P40     | 347        |
